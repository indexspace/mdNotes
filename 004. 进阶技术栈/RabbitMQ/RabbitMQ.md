# 基础-RabbitMQ



## 安装步骤略 

(详见安装手册)



## 基本介绍

![image-20231101120604920](./image-20231101120604920.png)

+ **生产者**发送消息到**交换机**
+ **交换机**将消息**路由**至**队列**
    + **交换机**是负责路由和转发消息的, 不具备消息的存储功能
+ **队列**可被**消费者**监听



## 快速入门

运行``RabbitMQ`并打开`localhost:15672` *(详见安装手册)*



<img src="./image-20231101151804800.png" alt="image-20231101151804800" style="zoom:50%;" />



### 创建队列

![image-20231101150533361](./image-20231101150533361.png)



### 交换机+

**打开交换机、绑定队列并发送消息**

<img src="./image-20231101150742876.png" alt="image-20231101150742876" style="zoom:80%;" />

<img src="./image-20231101150927796.png" alt="image-20231101150927796" style="zoom:70%;" />

<img src="./image-20231101151019173.png" alt="image-20231101151019173" style="zoom:70%;" />



### 检验消息

在队列中,

![image-20231101151401206](./image-20231101151401206.png)

![image-20231101151431062](./image-20231101151431062.png)

<img src="./image-20231101151531261.png" alt="image-20231101151531261" style="zoom:80%;" />

我们发送的消息就是" hello, MQ " , 至此,检验完毕



## 数据隔离

### 创建用户

![image-20231101152533399](./image-20231101152533399.png)



### 创建虚拟主机

![image-20231101152640861](./image-20231101152640861.png)

**注意: 虚拟主机属于它的创建用户**

虚拟主机之间数据是**隔离**的

右上角可以切换虚拟主机和**当前登录**的用户



# 基础-Java客户端

![image-20231101153830383](./image-20231101153830383.png)



## 快速入门-amqp

### 1.引入依赖

![image-20231101154734644](./image-20231101154734644.png)

### 2. 配置文件

<img src="./image-20231101155057758.png" alt="image-20231101155057758" style="zoom:67%;" />

**注意**: **15672**是RabbitMQ**控制台**的的端口, **5672**是**发送消息**的端口

### 3. 发送消息

<img src="./image-20231101160104657.png" alt="image-20231101160104657" style="zoom:67%;" />

### 4. 接收消息

<img src="./image-20231101160836636.png" alt="image-20231101160836636" style="zoom:67%;" />



## 模型与交换机

### work模型

![image-20231101162011700](./image-20231101162011700.png)

<img src="./image-20231101193850922.png" alt="image-20231101193850922" style="zoom: 67%;" />



### fanout广播交换机

<img src="./image-20231101194744516.png" alt="image-20231101194744516" style="zoom:80%;" />

![image-20231101195929401](./image-20231101195929401.png)



### direct定向交换机

<img src="./image-20231101195017414.png" alt="image-20231101195017414" style="zoom:67%;" />

![image-20231101195650520](./image-20231101195650520.png)

在15672控制台可以为队列设置**routingKey**, 

在Java客户端, `rabbitTemplate.convertAndSend()`,第一个参数传入交换机名称, **第二个参数指定routingKey**, 第三个参数指定具体的消息Object



### topic话题交换机

<img src="./image-20231101200239670.png" alt="image-20231101200239670" style="zoom:67%;" />

<img src="./image-20231101200634889.png" alt="image-20231101200634889" style="zoom:75%;" />

<img src="./image-20231101200656481.png" alt="image-20231101200656481" style="zoom:75%;" />

<img src="./image-20231101200818252.png" alt="image-20231101200818252" style="zoom:67%;" />



## 声明交换机和队列

<img src="./image-20231101202110430.png" alt="image-20231101202110430" style="zoom:75%;" />

声明交换机与队列并绑定

### @Bean声明

**方法一**

fanout

<img src="./image-20231101205555101.png" alt="image-20231101205555101" style="zoom:67%;" />

direct

<img src="./image-20231101211427588.png" alt="image-20231101211427588" style="zoom:67%;" />

**方法二**

<img src="./image-20231101205735349.png" alt="image-20231101205735349" style="zoom:67%;" />

 

### 注解声明*-方便*

![image-20231101211815366](./image-20231101211815366.png)



 ## 消息转化器

<img src="./image-20231102123454043.png" alt="image-20231102123454043" style="zoom:67%;" />

可以 传输Map类型的数据 来对比注册消息转化器前后的变化



# 高级-可靠性

## 生产者可靠性

### 生产者重连

> 生产者连不上MQ时会进行等待和重连
>
> 下面的相关的配置, 可以stop MQ来测试

![image-20231102143007083](./image-20231102143007083.png)

![image-20231102143612365](./image-20231102143612365.png)

### 生产者确认

![image-20231102143908231](./image-20231102143908231.png)

配置文件

![image-20231102144113031](./image-20231102144113031.png)

方法一: Return只需要写一个CallBack

![image-20231102144344513](./image-20231102144344513.png)

方法二: Confirm需要写多个Callback

![image-20231102144559032](./image-20231102144559032.png)



注意: 无需开启Return, 路由失败是业务问题

![image-20231102150450713](./image-20231102150450713.png)





## MQ可靠性

### 持久化Message

> 当队列堵塞时, 会将部分**持久化**的消息从内存取出, 保存至磁盘, 以此来缓解内存的压力, 同时提高消息的可靠性

![image-20231102152451292](./image-20231102152451292.png)



### 惰性队列

![image-20231102153045346](./image-20231102153045346.png)

注解定义惰性队列

![image-20231102153254044](./image-20231102153254044.png)



## 消费者可靠性

### 消费者确认

![image-20231102153559750](./image-20231102153559750.png)

配置文件

![image-20231102153808237](./image-20231102153808237.png)



### 消费者重试

配置文件

![image-20231102154415144](./image-20231102154415144.png)



重试失败后的处理策略

![image-20231102172543639](./image-20231102172543639.png)

配置类

![image-20231102173056141](./image-20231102173056141.png)

>  注意: 注解`@ConditionalOnProperty`表示当配置文件的 指定属性的值 为 指定值 时, 该配置类生效
>
> 如下 当配置文件中`spring.rabbitmq.listener.simple.retry.enable=true`成立时才会使当前配置类生效   *//路径属性为`prefix`+`name`*![image-20231102174100822](./image-20231102174100822.png)

<img src="./image-20231102182106327.png" alt="image-20231102182106327" style="zoom:60%;" />

### 幂等性

方案一: 唯一ID

<img src="./image-20231102183115366.png" alt="image-20231102183115366" style="zoom:67%;" />

 





# 高级-延迟消息

## 死信交换机

![image-20231102191438664](./image-20231102191438664.png)

> 创建队列时绑定死信交换机
>
> <img src="./image-20231102192116463.png" alt="image-20231102192116463" style="zoom:67%;" />
>
> 在Java中, 发送消息时, 指定TTL 单位毫秒
>
> <img src="./image-20231102192218105.png" alt="image-20231102192218105" style="zoom:67%;" />

 

## 插件

1. ? 安装插件:  rabbitmq-plugins enable rabbitmq_delayed_message_exchange

2. 注解 或 @Bean  配置延时交换机:![image-20231102193908286](./image-20231102193908286.png)
2. 发送消息时设置延迟时间![image-20231102194137538](./image-20231102194137538.png)





















